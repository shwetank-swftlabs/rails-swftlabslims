<!-- Use Records Header + Add Usage Button -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="text-muted fw-bold mb-0">Use Records</h3>
    <% if resource.present? && resource.respond_to?(:remaining_amount) %>
      <p class="text-muted mb-0" style="font-size: 0.85rem;">
        Remaining: <strong><%= number_with_precision(resource.remaining_amount, precision: 2, strip_insignificant_zeros: true) %> <%= usage_unit.upcase %></strong>
      </p>
    <% end %>
  </div>

  <button 
    class="btn btn-secondary d-flex align-items-center"
    data-bs-toggle="modal"
    data-bs-target="#addUsageModal"
    style="font-size: 0.9rem;"
  >
    <i class="bi bi-journal-text me-2"></i>
    Add Record
  </button>
</div>

<style>
  .table tbody tr.usage-row-addition {
    background-color: rgba(108, 117, 125, 0.08) !important;
    border-left: 4px solid #6c757d !important;
  }
  .table tbody tr.usage-row-addition:hover {
    background-color: rgba(108, 117, 125, 0.12) !important;
  }
  .table tbody tr.usage-row-addition:nth-child(even) {
    background-color: rgba(108, 117, 125, 0.08) !important;
  }
  .table tbody tr.usage-row-addition:nth-child(odd) {
    background-color: rgba(108, 117, 125, 0.08) !important;
  }
  .table tbody tr.usage-row-use {
    background-color: rgba(108, 117, 125, 0.08) !important;
    border-left: 4px solid #6c757d !important;
  }
  .table tbody tr.usage-row-use:hover {
    background-color: rgba(108, 117, 125, 0.12) !important;
  }
  .table tbody tr.usage-row-use:nth-child(even) {
    background-color: rgba(108, 117, 125, 0.08) !important;
  }
  .table tbody tr.usage-row-use:nth-child(odd) {
    background-color: rgba(108, 117, 125, 0.08) !important;
  }
  .amount-display {
    color: #495057 !important;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }
</style>

<%= render "shared/tables/default_table",
    collection: usages || [],
    pagy: pagy,
    row_class: ->(usage) { usage.is_for_addition? ? 'usage-row-addition' : 'usage-row-use' },
    headers: ->(_) do %>
      <th>Amount</th>
      <th>Purpose</th>
      <th>Date</th>
      <th>Created By</th>
      <th>Actions</th>
    <% end,
    row: ->(usage) do %>
      <td>
        <span class="amount-display">
          <% if usage.is_for_addition? %>
            <i class="bi bi-plus-circle"></i>
            +<%= number_with_precision(usage.amount, precision: 2, strip_insignificant_zeros: true) %> <%= usage_unit.upcase %>
          <% else %>
            <i class="bi bi-dash-circle"></i>
            -<%= number_with_precision(usage.amount, precision: 2, strip_insignificant_zeros: true) %> <%= usage_unit.upcase %>
          <% end %>
        </span>
      </td>
      <td><%= usage.purpose %></td>
      <td><%= format_date(usage.created_at) %></td>
      <td><%= email_to_name(usage.created_by) %></td>
      <td>
        <button 
          class="btn btn-sm btn-outline-primary edit-usage-btn"
          data-bs-toggle="modal"
          data-bs-target="#editUsageModal"
          data-usage-id="<%= usage.id %>"
          data-usage-amount="<%= usage.amount %>"
          data-usage-purpose="<%= usage.purpose %>"
          data-usage-created-at="<%= usage.created_at&.strftime('%Y-%m-%d') %>"
          data-usage-is-active="<%= usage.is_active? %>"
          data-usage-is-for-addition="<%= usage.is_for_addition? %>"
          data-update-url="<%= polymorphic_path([resource, usage]) %>"
          style="font-size: 0.85rem;"
        >
          <i class="bi bi-pencil"></i> Edit
        </button>
      </td>
    <% end %>


<!-- Modal -->
<div class="modal fade" id="addUsageModal" tabindex="-1" aria-labelledby="addUsageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-lg-down" style="max-width: 70vh">
    <div class="modal-content p-4">

      <div class="modal-header">
        <h5 class="modal-title" id="addUsageModalLabel">Add Record for <%= resource.name %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with(
        url: url,
        scope: :use_record,
        local: true,
        data: { turbo: false }
      ) do |form| %>
        <div class="modal-body">
          <% if resource.present? && resource.respond_to?(:remaining_amount) %>
            <div class="alert alert-info mb-3" style="font-size: 0.9rem;">
              <strong>Amount Remaining:</strong> <%= number_with_precision(resource.remaining_amount, precision: 2, strip_insignificant_zeros: true) %> <%= usage_unit.upcase %>
            </div>
          <% end %>

          <%= default_form_field(form, :is_for_addition, label_text: "Type") do |req| %>
            <div class="d-flex align-items-center gap-3">
              <div class="form-check form-switch">
                <%= form.check_box :is_for_addition, { class: "form-check-input", id: "addUsageIsForAddition", onchange: "updateAddUsageLabels()" } %>
                <label class="form-check-label" for="addUsageIsForAddition">
                  <span id="addUsageTypeLabel">Use Amount</span>
                </label>
              </div>
              <small class="text-muted">
                (<span id="addUsageTypeHint">Toggle to add amount instead of using</span>)
              </small>
            </div>
          <% end %>

          <%= inline_quantity_field(form, :amount, "Amount", required: true, unit_field: nil, default_units: usage_unit.upcase) %>

          <div class="mb-3">
            <%= form.label :purpose, "Purpose", class: "form-label" %>
            <select id="purposeSelect" class="form-select mb-2" onchange="handlePurposeSelect(this)">
              <option value="">Select a purpose...</option>
              <% usage_purposes.each do |purpose| %>
                <option value="<%= purpose %>"><%= purpose.humanize %></option>
              <% end %>
            </select>
            <%= form.text_field :purpose, 
                id: "purposeInput",
                class: "form-control", 
                required: true,
                placeholder: "Enter purpose of usage" %>
          </div>

          <%= render "shared/forms/creator_fields", f: form %>
        </div>

        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancel</button>
          <%= form.button type: "submit", class: "btn btn-primary d-flex align-items-center", onclick: "return handleUseRecordSubmit(event)", id: "addUsageSubmitBtn" do %>
            <i class="bi bi-journal-text me-2"></i>
            <span id="addUsageSubmitText">Add Use Record</span>
          <% end %>
        </div>
      <% end %>

    </div>
  </div>
</div>

<script>
  function updateAddUsageLabels() {
    const checkbox = document.getElementById('addUsageIsForAddition');
    const typeLabel = document.getElementById('addUsageTypeLabel');
    const typeHint = document.getElementById('addUsageTypeHint');
    const submitText = document.getElementById('addUsageSubmitText');
    
    if (checkbox && checkbox.checked) {
      if (typeLabel) typeLabel.textContent = 'Add Amount';
      if (typeHint) typeHint.textContent = 'Toggle to use amount instead of adding';
      if (submitText) submitText.textContent = 'Add Record';
    } else {
      if (typeLabel) typeLabel.textContent = 'Use Amount';
      if (typeHint) typeHint.textContent = 'Toggle to add amount instead of using';
      if (submitText) submitText.textContent = 'Add Use Record';
    }
  }

  function updateEditUsageLabels() {
    const checkbox = document.getElementById('editUsageIsForAddition');
    const typeLabel = document.getElementById('editUsageTypeLabel');
    const typeHint = document.getElementById('editUsageTypeHint');
    const amountLabel = document.getElementById('editUsageAmountLabel');
    const submitText = document.getElementById('editUsageSubmitText');
    
    if (checkbox && checkbox.checked) {
      if (typeLabel) typeLabel.textContent = 'Add Amount';
      if (typeHint) typeHint.textContent = 'Toggle to use amount instead of adding';
      if (amountLabel) amountLabel.textContent = 'Amount Added';
      if (submitText) submitText.textContent = 'Update Record';
    } else {
      if (typeLabel) typeLabel.textContent = 'Use Amount';
      if (typeHint) typeHint.textContent = 'Toggle to add amount instead of using';
      if (amountLabel) amountLabel.textContent = 'Amount Used';
      if (submitText) submitText.textContent = 'Update Record';
    }
  }

  function handlePurposeSelect(select) {
    const purposeInput = document.getElementById('purposeInput');
    const selectedOption = select.options[select.selectedIndex];
    const selectedValue = select.value;
    
    if (selectedValue && selectedValue !== 'other') {
      // Auto-fill the input with the humanized option text
      purposeInput.value = selectedOption.text;
    } else if (selectedValue === 'other') {
      // Clear the input when 'other' is selected so user can type custom value
      purposeInput.value = '';
      purposeInput.focus();
    } else {
      // Clear when no selection
      purposeInput.value = '';
    }
  }

  function handleUseRecordSubmit(event) {
    // Confirm before submitting
    if (!confirm('Are you sure you want to add this use record?')) {
      event.preventDefault();
      return false;
    }

    // Clean up modal state before form submission to prevent layout issues
    // This is especially important in production where Turbo might intercept redirects
    const modal = document.getElementById('addUsageModal');
    if (modal) {
      // Remove modal backdrop
      const backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(backdrop => backdrop.remove());
      
      // Reset body styles
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
      // Hide modal
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      modal.style.display = '';
    }

    // Allow form to submit normally
    return true;
  }
</script>

<!-- Edit Usage Modal -->
<div class="modal fade" id="editUsageModal" tabindex="-1" aria-labelledby="editUsageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-lg-down" style="max-width: 70vh">
    <div class="modal-content p-4">

      <div class="modal-header">
        <h5 class="modal-title" id="editUsageModalLabel">Edit Record for <%= resource.name %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with(
        url: "#",
        scope: :usage,
        local: true,
        method: :patch,
        data: { turbo: false },
        html: { id: "editUsageForm" }
      ) do |form| %>
        <div class="modal-body">
          <%= default_form_field(form, :is_active, label_text: "Status") do |req| %>
            <div class="d-flex align-items-center gap-3">
              <div class="form-check form-switch">
                <%= form.check_box :is_active, { class: "form-check-input", id: "editUsageIsActive" } %>
                <label class="form-check-label" for="editUsageIsActive">
                  <span id="editUsageStatusLabel">Active</span>
                </label>
              </div>
              <small class="text-muted">
                (<span id="editUsageStatusHint">Toggle to change status</span>)
              </small>
            </div>
          <% end %>

          <%= default_form_field(form, :is_for_addition, label_text: "Type") do |req| %>
            <div class="d-flex align-items-center gap-3">
              <div class="form-check form-switch">
                <%= form.check_box :is_for_addition, { class: "form-check-input", id: "editUsageIsForAddition", onchange: "updateEditUsageLabels()" } %>
                <label class="form-check-label" for="editUsageIsForAddition">
                  <span id="editUsageTypeLabel">Use Amount</span>
                </label>
              </div>
              <small class="text-muted">
                (<span id="editUsageTypeHint">Toggle to add amount instead of using</span>)
              </small>
            </div>
          <% end %>

          <div class="mb-3">
            <label class="form-label fw-bold mb-1 d-block">
              <span id="editUsageAmountLabel">Amount</span> <span class="text-danger">*</span>
            </label>
            <div class="d-flex gap-2 align-items-center">
              <%= form.number_field :amount, 
                  id: "editUsageAmount",
                  class: "form-control",
                  step: :any,
                  min: 0,
                  required: true,
                  style: "max-width: 150px" %>
              <span class="ms-2"><%= usage_unit.upcase %></span>
            </div>
          </div>

          <div class="mb-3">
            <%= form.label :purpose, "Purpose", class: "form-label fw-bold mb-1" %>
            <%= form.text_field :purpose, 
                id: "editPurposeInput",
                class: "form-control", 
                required: true,
                placeholder: "Enter purpose of usage" %>
          </div>

          <div class="mb-3">
            <%= form.label :created_at, "Date", class: "form-label fw-bold mb-1" %>
            <%= form.date_field :created_at,
                id: "editUsageCreatedAt",
                class: "form-control",
                required: true %>
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancel</button>
          <%= form.button type: "submit", class: "btn btn-primary d-flex align-items-center", onclick: "return handleEditUseRecordSubmit(event)", id: "editUsageSubmitBtn" do %>
            <i class="bi bi-pencil me-2"></i>
            <span id="editUsageSubmitText">Update Record</span>
          <% end %>
        </div>
      <% end %>

    </div>
  </div>
</div>

<script>
  // Populate edit modal when edit button is clicked
  function initEditUsageModal() {
    const editModal = document.getElementById('editUsageModal');
    if (editModal) {
      // Use event delegation on document to avoid duplicate listeners
      // This will work even after Turbo navigation replaces the modal
      editModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        if (button && button.classList.contains('edit-usage-btn')) {
          const usageId = button.getAttribute('data-usage-id');
          const usageAmount = button.getAttribute('data-usage-amount');
          const usagePurpose = button.getAttribute('data-usage-purpose');
          const usageCreatedAt = button.getAttribute('data-usage-created-at');
          const usageIsActive = button.getAttribute('data-usage-is-active') === 'true';
          const usageIsForAddition = button.getAttribute('data-usage-is-for-addition') === 'true';
          const updateUrl = button.getAttribute('data-update-url');

          // Set form action URL and ensure all hidden fields are correct
          const form = document.getElementById('editUsageForm');
          if (form) {
            form.action = updateUrl;
            form.method = 'post'; // Rails uses POST with _method field for PATCH
            
            // Ensure _method field is set to 'patch'
            let methodInput = form.querySelector('input[name="_method"]');
            if (!methodInput) {
              methodInput = document.createElement('input');
              methodInput.type = 'hidden';
              methodInput.name = '_method';
              form.appendChild(methodInput);
            }
            methodInput.value = 'patch';
            
            // Ensure CSRF token is present and up-to-date
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
              let csrfInput = form.querySelector('input[name="authenticity_token"]');
              if (csrfInput) {
                csrfInput.value = metaToken.getAttribute('content');
              } else {
                // Create CSRF token input if it doesn't exist
                csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'authenticity_token';
                csrfInput.value = metaToken.getAttribute('content');
                form.insertBefore(csrfInput, form.firstChild);
              }
            }
          }

          // Populate form fields
          const amountField = document.getElementById('editUsageAmount');
          if (amountField) {
            amountField.value = usageAmount || '';
          }

          const purposeInput = document.getElementById('editPurposeInput');
          if (purposeInput) {
            purposeInput.value = usagePurpose || '';
          }

          const createdAtField = document.getElementById('editUsageCreatedAt');
          if (createdAtField) {
            createdAtField.value = usageCreatedAt || '';
          }

          const isActiveCheckbox = document.getElementById('editUsageIsActive');
          const statusLabel = document.getElementById('editUsageStatusLabel');
          const statusHint = document.getElementById('editUsageStatusHint');
          if (isActiveCheckbox) {
            isActiveCheckbox.checked = usageIsActive;
            updateStatusLabels(isActiveCheckbox.checked, statusLabel, statusHint);
            
            // Update labels when checkbox changes (using onchange to avoid multiple listeners)
            isActiveCheckbox.onchange = function() {
              const currentStatusLabel = document.getElementById('editUsageStatusLabel');
              const currentStatusHint = document.getElementById('editUsageStatusHint');
              updateStatusLabels(this.checked, currentStatusLabel, currentStatusHint);
            };
          }

          const isForAdditionCheckbox = document.getElementById('editUsageIsForAddition');
          if (isForAdditionCheckbox) {
            isForAdditionCheckbox.checked = usageIsForAddition;
            updateEditUsageLabels();
            
            // Update labels when checkbox changes
            isForAdditionCheckbox.onchange = function() {
              updateEditUsageLabels();
            };
          }
        }
      });
    }
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEditUsageModal);
  } else {
    initEditUsageModal();
  }

  // Re-initialize on Turbo navigation
  document.addEventListener('turbo:load', initEditUsageModal);

  function updateStatusLabels(isActive, statusLabel, statusHint) {
    if (statusLabel) {
      statusLabel.textContent = isActive ? 'Active' : 'Delete';
    }
    if (statusHint) {
      statusHint.textContent = isActive ? 'Uncheck to mark as deleted' : 'Check to mark as active';
    }
  }


  function handleEditUseRecordSubmit(event) {
    // Confirm before submitting
    if (!confirm('Are you sure you want to update this use record?')) {
      event.preventDefault();
      return false;
    }

    // Clean up modal state before form submission to prevent layout issues
    const modal = document.getElementById('editUsageModal');
    if (modal) {
      // Remove modal backdrop
      const backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(backdrop => backdrop.remove());
      
      // Reset body styles
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
      // Hide modal
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      modal.style.display = '';
    }

    // Allow form to submit normally
    return true;
  }
</script>
