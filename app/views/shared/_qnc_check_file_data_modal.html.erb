<!-- View File Data Modal (for QNC checks, rendered once to avoid Turbo conflicts) -->
<div class="modal fade" id="viewQncCheckFileDataModal" tabindex="-1" aria-labelledby="viewQncCheckFileDataModalLabel" aria-hidden="true" data-turbo-permanent>
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewQncCheckFileDataModalLabel">View File Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="viewQncCheckFileDataModalBody">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize modal cleanup listener only once
  (function() {
    function initModalListener() {
      const viewQncCheckFileDataModal = document.getElementById('viewQncCheckFileDataModal');
      if (viewQncCheckFileDataModal && !viewQncCheckFileDataModal.dataset.listenerAttached) {
        viewQncCheckFileDataModal.dataset.listenerAttached = 'true';
        viewQncCheckFileDataModal.addEventListener('hidden.bs.modal', function () {
          const modalBody = document.getElementById('viewQncCheckFileDataModalBody');
          const modalTitle = document.getElementById('viewQncCheckFileDataModalLabel');
          if (modalBody) {
            modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
          }
          if (modalTitle) {
            modalTitle.textContent = 'View File Data';
          }
        });
      }
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initModalListener);
    } else {
      initModalListener();
    }

    // Also handle Turbo loads
    document.addEventListener('turbo:load', initModalListener);
  })();
  
  // Function to load file data into the modal (only define if not already defined)
  if (typeof loadQncCheckFileData === 'undefined') {
    window.loadQncCheckFileData = function(button) {
      const dataFileUrl = button.getAttribute('data-data-file-url');
      const dataFileName = button.getAttribute('data-data-file-name');
      const modalBody = document.getElementById('viewQncCheckFileDataModalBody');
      const modalTitle = document.getElementById('viewQncCheckFileDataModalLabel');
      
      if (!modalBody || !modalTitle) {
        console.error('Modal elements not found');
        return;
      }
      
      if (!dataFileUrl) {
        console.error('Data file URL not found');
        modalBody.innerHTML = '<div class="alert alert-danger">Error: Data file URL not found.</div>';
        return;
      }
      
      // Update modal title with file name
      if (dataFileName) {
        modalTitle.textContent = 'View File Data: ' + dataFileName;
      }
      
      // Show loading state
      modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      
      // Fetch the data
      fetch(dataFileUrl, {
        headers: {
          'Accept': 'text/html',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.text();
      })
      .then(html => {
        modalBody.innerHTML = html;
      })
      .catch(error => {
        console.error('Error loading file data:', error);
        modalBody.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error loading file data. Please try again.</div>';
      });
    };
  }
</script>

