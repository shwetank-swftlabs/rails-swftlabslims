<% 
  pending_notification = if @pending_qnc_checks_count.to_i > 0
    content_tag(:div, class: "d-flex flex-column align-items-end gap-2") do
      content_tag(:div, class: "badge bg-warning text-dark d-flex align-items-center gap-1", style: "font-size: 0.875rem; padding: 0.5rem 0.75rem; white-space: nowrap;") do
        content_tag(:i, "", class: "bi bi-exclamation-circle") +
        "You have #{@pending_qnc_checks_count} pending QNC check#{@pending_qnc_checks_count == 1 ? '' : 's'}"
      end +
      render("shared/add_button", label: "Add New QNC Check", path: new_experiments_qnc_check_path)
    end
  else
    render("shared/add_button", label: "Add New QNC Check", path: new_experiments_qnc_check_path)
  end
%>

<% content_for :page_title, render("shared/page_title",
  subtitle: "Manage QNC checks and their data.",
  actions: pending_notification
) %>

<!-- UNIFIED FILTER BAR -->
<%= render "shared/tables/default_filter_bar",
    url: experiments_qnc_checks_path,
    search_placeholder: "Search by name…",
    filter_fields: ->(f) do %>

  <!-- Resource Name Filter -->
  <div class="col-md-3">
    <div class="input-group">
      <%= f.text_field :resource_name,
            value: params[:resource_name],
            placeholder: "Filter by resource name…",
            class: "form-control" %>
      <%= f.submit "Search", class: "btn btn-secondary" %>
    </div>
  </div>

  <!-- Assigned To Filter -->
  <div class="col-md-3">
    <div class="input-group">
      <%= f.text_field :assigned_to,
            value: params[:assigned_to],
            placeholder: "Filter by assigned to…",
            class: "form-control" %>
      <%= f.submit "Search", class: "btn btn-secondary" %>
    </div>
  </div>

  <!-- Requested By Filter -->
  <div class="col-md-3">
    <div class="input-group">
      <%= f.text_field :requested_by,
            value: params[:requested_by],
            placeholder: "Filter by requested by…",
            class: "form-control" %>
      <%= f.submit "Search", class: "btn btn-secondary" %>
    </div>
  </div>

  <!-- Status Filter -->
  <div class="col-md-3">
    <%= f.select :is_active,
        [["Pending", "true"], ["Completed", "false"], ["All", ""]],
        {
          include_blank: false,
          selected: params.key?(:is_active) ? params[:is_active] : "true"
        },
        class: "form-select",
        onchange: "this.form.submit();" %>
  </div>

<% end %>

<!-- ACTIVE FILTERS -->
<% active_filters = [] %>
<% active_filters << { label: "Name: #{params[:q]}", param: :q } if params[:q].present? %>
<% active_filters << { label: "Resource: #{params[:resource_name]}", param: :resource_name } if params[:resource_name].present? %>
<% active_filters << { label: "Assigned To: #{params[:assigned_to]}", param: :assigned_to } if params[:assigned_to].present? %>
<% active_filters << { label: "Requested By: #{params[:requested_by]}", param: :requested_by } if params[:requested_by].present? %>
<% 
  # Always show status filter badge
  is_active_value = params.key?(:is_active) ? params[:is_active] : "true"
  status_label = case is_active_value
                 when "true" then "Pending"
                 when "false" then "Completed"
                 when "" then "All"
                 else "Pending"
                 end
  active_filters << { label: "Status: #{status_label}", param: :is_active }
%>

<% if active_filters.any? %>
  <div class="mb-3">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <span class="text-muted small fw-bold">Active Filters:</span>
      <% active_filters.each do |filter| %>
        <% 
          # Build URL without this filter, preserving other params
          filter_params = params.to_unsafe_h.except(filter[:param], :controller, :action)
          clear_url = experiments_qnc_checks_path(filter_params)
        %>
        <a href="<%= clear_url %>" class="badge bg-secondary text-decoration-none d-flex align-items-center gap-1" style="font-size: 0.875rem;">
          <%= filter[:label] %>
          <i class="bi bi-x-circle" style="font-size: 0.75rem;"></i>
        </a>
      <% end %>
      <% if active_filters.length > 1 %>
        <% 
          # Clear all but preserve default status (Pending)
          clear_all_params = { is_active: "true" }
          clear_all_url = experiments_qnc_checks_path(clear_all_params)
        %>
        <a href="<%= clear_all_url %>" class="badge bg-danger text-decoration-none" style="font-size: 0.875rem;">
          Clear All
        </a>
      <% end %>
    </div>
  </div>
<% end %>

<!-- QNC CHECKS TABLE -->
<%= render "experiments/qnc_checks/qnc_checks_table",
           qnc_checks: @qnc_checks %>

<!-- View File Data Modal -->
<%= render "shared/qnc_check_file_data_modal" %>

