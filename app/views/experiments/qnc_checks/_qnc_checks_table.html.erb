<% 
  qnc_checks = local_assigns[:qnc_checks] || @qnc_checks || []
  show_expandable = local_assigns.fetch(:show_expandable, false)
%>

<style>
  .check-name-column {
    background-color: rgba(92, 126, 165, 0.08);
  }
  .check-name-column:hover {
    background-color: rgba(92, 126, 165, 0.12);
  }
  table .check-name-column a.check-name-link,
  table .check-name-column .check-name-link,
  .table .check-name-column a.check-name-link {
    color: #5c7ea5 !important;
  }
  table .check-name-column a.check-name-link:hover,
  table .check-name-column .check-name-link:hover,
  .table .check-name-column a.check-name-link:hover,
  table .check-name-column a.check-name-link:focus,
  table .check-name-column .check-name-link:focus,
  .table .check-name-column a.check-name-link:focus {
    color: #4d6a8a !important;
  }
  table .check-name-column a.check-name-link:visited,
  .table .check-name-column a.check-name-link:visited {
    color: #5c7ea5 !important;
  }
  
  /* Highlight rows assigned to current user */
  .table tbody tr.qnc-check-assigned-to-me {
    background-color: rgba(173, 216, 230, 0.15) !important;
    border-left: 4px solid #87CEEB !important;
  }
  .table tbody tr.qnc-check-assigned-to-me:hover {
    background-color: rgba(173, 216, 230, 0.2) !important;
  }
  .table tbody tr.qnc-check-assigned-to-me:nth-child(even) {
    background-color: rgba(173, 216, 230, 0.15) !important;
  }
  .table tbody tr.qnc-check-assigned-to-me:nth-child(odd) {
    background-color: rgba(173, 216, 230, 0.15) !important;
  }
  
  /* Custom light blue badge for "You" indicator */
  .badge.bg-assigned-to-me {
    background-color: #87CEEB !important;
    color: #2c3e50 !important;
  }
  
  /* Expandable row styles */
  .toggle-arrow {
    cursor: pointer;
    color: #6c757d;
    transition: transform 0.2s ease;
    font-size: 0.9rem;
  }
  .toggle-arrow:hover {
    color: #495057;
  }
  .toggle-arrow.expanded {
    transform: rotate(90deg);
  }
  .data-files-row {
    display: none;
  }
  .data-files-row.expanded {
    display: table-row;
  }
  .data-files-content {
    background-color: #f8f9fa;
    padding: 1rem;
    border-left: 3px solid #dee2e6;
    margin-left: 1rem;
  }
  .data-files-table {
    font-size: 0.85rem;
    margin-bottom: 0;
  }
  .data-files-row {
    background-color: #f8f9fa !important;
  }
</style>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle table-compact">
    <thead class="table-light border-bottom">
      <tr>
        <% if show_expandable %>
          <th style="width: 30px;"></th>
        <% end %>
        <th class="check-name-column">
          <i class="bi bi-pencil-square me-2"></i>Check Name
        </th>
        <th>Resource</th>
        <th>Location</th>
        <th>Assigned To</th>
        <th>Expected Completion</th>
        <th>Requested By</th>
        <th>Status</th>
        <th>Created At</th>
        <th>Print QR</th>
      </tr>
    </thead>

    <tbody>
      <% if qnc_checks.any? %>
        <% qnc_checks.each do |qnc_check| %>
          <% 
            is_assigned_to_me = current_user.present? && qnc_check.requested_from.present? && qnc_check.requested_from.downcase == current_user.email.downcase
            row_class = is_assigned_to_me ? "qnc-check-assigned-to-me" : ""
            data_files = qnc_check.data_files
            has_files = data_files.any?
          %>
          <!-- QNC Check Row -->
          <tr class="<%= row_class %>" data-qnc-check-id="<%= qnc_check.id %>">
            <% if show_expandable %>
              <td>
                <% if has_files %>
                  <i class="bi bi-chevron-right toggle-arrow" 
                     onclick="toggleQncCheckDataFiles(<%= qnc_check.id %>)" 
                     id="toggle-<%= qnc_check.id %>"
                     title="Toggle data files"></i>
                <% end %>
              </td>
            <% end %>
            <td class="check-name-column">
              <%= link_to experiments_qnc_check_request_path(qnc_check),
                          class: "check-name-link text-decoration-underline fw-semibold d-inline-flex align-items-center gap-1" do %>
                <i class="bi bi-pencil"></i>
                <%= qnc_check.name.presence || "Unnamed" %>
              <% end %>
            </td>
            <td>
              <% parent = qnc_check.qnc_check_requestable %>
              <% if parent.present? && parent.respond_to?(:name) && parent.name.present? %>
                <%= link_to parent.name, polymorphic_path(parent), class: "text-decoration-underline" %>
              <% else %>
                —
              <% end %>
            </td>
            <td><%= qnc_check.location.presence || "—" %></td>
            <td>
              <% if qnc_check.requested_from.present? %>
                <span class="d-inline-flex align-items-center gap-1">
                  <%= email_to_name(qnc_check.requested_from) %>
                  <% if is_assigned_to_me %>
                    <span class="badge bg-assigned-to-me" style="font-size: 0.7rem;" title="Assigned to you">
                      <i class="bi bi-person-check me-1"></i>You
                    </span>
                  <% end %>
                </span>
              <% else %>
                —
              <% end %>
            </td>
            <td><%= qnc_check.expected_completion_date.present? ? format_date(qnc_check.expected_completion_date) : "—" %></td>
            <td><%= qnc_check.requested_by.present? ? email_to_name(qnc_check.requested_by) : "—" %></td>
            <td>
              <% if qnc_check.is_active? %>
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-clock me-1"></i>Pending
                </span>
              <% else %>
                <span class="badge bg-success">
                  <i class="bi bi-check-circle me-1"></i>Completed
                </span>
              <% end %>
            </td>
            <td><%= format_date(qnc_check.created_at) %></td>
            <td>
              <%= render "shared/print_qr_button", 
                          qr_code_path: qr_code_experiments_qnc_check_request_path(qnc_check),
                          label: "Print QR" %>
            </td>
          </tr>
          
          <!-- Data Files Row (collapsible) -->
          <% if show_expandable && has_files %>
            <tr class="data-files-row" id="data-files-<%= qnc_check.id %>" data-qnc-check-id="<%= qnc_check.id %>">
              <td colspan="<%= show_expandable ? 10 : 9 %>" class="p-0">
                <div class="data-files-content">
                  <div class="d-flex align-items-center gap-2 mb-3 pb-2 border-bottom">
                    <i class="bi bi-arrow-return-right text-muted"></i>
                    <h6 class="fw-semibold mb-0">
                      QNC Check Request Data Files
                      <span class="badge bg-secondary ms-2" style="font-size: 0.75rem;"><%= data_files.count %> file<%= data_files.count == 1 ? '' : 's' %></span>
                    </h6>
                  </div>
                  <table class="table table-sm table-bordered data-files-table">
                    <thead class="table-light">
                      <tr>
                        <th class="py-2 ps-3">File Name</th>
                        <th class="py-2 ps-3">Label</th>
                        <th class="py-2 ps-3">Data Type</th>
                        <th class="py-2 ps-3">Uploaded By</th>
                        <th class="py-2 ps-3">Date</th>
                        <th class="py-2 ps-3">View Data</th>
                        <th class="py-2 ps-3">Open File</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% data_files.each do |data_file| %>
                        <tr>
                          <td class="py-2 ps-3">
                            <a href="<%= data_file.drive_file_url %>" target="_blank" class="text-decoration-none fw-semibold">
                              <%= data_file.file_name %>
                            </a>
                          </td>
                          <td class="py-2 ps-3"><%= data_file.label.presence || "—" %></td>
                          <td class="py-2 ps-3"><%= data_file.data_type.humanize %></td>
                          <td class="py-2 ps-3"><%= email_to_name(data_file.created_by) %></td>
                          <td class="py-2 ps-3"><%= format_date(data_file.created_at) %></td>
                          <td class="py-2 ps-3">
                            <% if data_file.parsed_data.present? %>
                              <button 
                                class="btn btn-sm btn-outline-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#viewQncCheckFileDataModal"
                                data-data-file-id="<%= data_file.id %>"
                                data-data-file-url="<%= experiments_qnc_check_request_data_file_path(qnc_check, data_file) %>"
                                data-data-file-name="<%= data_file.file_name %>"
                                onclick="loadQncCheckFileData(this)">
                                <i class="bi bi-eye me-1"></i> View Data
                              </button>
                            <% else %>
                              <span class="text-muted">NA</span>
                            <% end %>
                          </td>
                          <td class="py-2 ps-3">
                            <a href="<%= data_file.drive_file_url %>" target="_blank" class="text-decoration-none">
                              <i class="bi bi-box-arrow-up-right"></i>
                              Open File
                            </a>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          <% end %>
        <% end %>
      <% else %>
        <tr>
          <td colspan="<%= show_expandable ? 10 : 9 %>" class="text-muted text-center py-3">No QNC check requests found.</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% if defined?(@pagy) && @pagy.present? %>
  <div class="mt-3">
    <%== @pagy.series_nav(:bootstrap) %>
  </div>
<% end %>

<% if show_expandable %>
<script>
  // Namespaced function to avoid conflicts - only define if not already defined
  if (typeof toggleQncCheckDataFiles === 'undefined') {
    window.toggleQncCheckDataFiles = function(qncCheckId) {
      const arrow = document.getElementById('toggle-' + qncCheckId);
      const dataFilesRow = document.getElementById('data-files-' + qncCheckId);
      
      if (!arrow || !dataFilesRow) return;
      
      const isExpanded = dataFilesRow.classList.contains('expanded');
      
      if (isExpanded) {
        // Collapse
        dataFilesRow.classList.remove('expanded');
        arrow.classList.remove('expanded');
        arrow.classList.remove('bi-chevron-down');
        arrow.classList.add('bi-chevron-right');
      } else {
        // Expand
        dataFilesRow.classList.add('expanded');
        arrow.classList.add('expanded');
        arrow.classList.remove('bi-chevron-right');
        arrow.classList.add('bi-chevron-down');
      }
    };
  }
</script>
<% end %>



