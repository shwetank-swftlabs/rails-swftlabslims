<% content_for :page_title, render("shared/page_title", subtitle: "Edit QNC check details.") %>

<%= render "shared/form_errors", object: @qnc_check %>

<%= form_with(model: @qnc_check, local: true, url: experiments_qnc_check_path(@qnc_check), method: :patch, html: { class: "qnc-check-form" }) do |f| %>

  <%= default_form_field(f, :name, label_text: "Name", required: true) do |req| %>
    <%= f.text_field :name,
                    { class: "form-control",
                      placeholder: "Enter QNC check name",
                      value: @qnc_check.name }.merge(req) %>
  <% end %>

  <%= default_form_field(f, :location, label_text: "Location", required: false) do |req| %>
    <%= f.text_field :location,
                    { class: "form-control",
                      placeholder: "Enter location (optional)",
                      value: @qnc_check.location } %>
  <% end %>

  <%= default_form_field(f, :requested_from, label_text: "Assigned To", required: true) do |req| %>
    <div class="position-relative">
      <%= f.text_field :requested_from,
          { 
            class: "form-control",
            id: "requestedFromInput",
            placeholder: "Search or type @swftlabs.com email",
            value: @qnc_check.requested_from,
            autocomplete: "off",
            "data-bs-toggle": "dropdown",
            "aria-expanded": "false",
            "aria-haspopup": "true"
          }.merge(req) %>
      <ul class="dropdown-menu w-100" id="userEmailsDropdown" style="max-height: 300px; overflow-y: auto;">
        <% @users.each do |user| %>
          <li>
            <a class="dropdown-item user-email-option" href="#" data-email="<%= user.email %>">
              <%= user.email %>
            </a>
          </li>
        <% end %>
      </ul>
    </div>
    <small class="text-muted">
      Must be a valid @swftlabs.com email address. You can search and select from the list or type a new email.
    </small>
  <% end %>

  <%= default_form_field(f, :expected_completion_date, label_text: "Expected Completion Date", required: true) do |req| %>
    <%= f.date_field :expected_completion_date,
                    { class: "form-control",
                      value: @qnc_check.expected_completion_date }.merge(req) %>
  <% end %>

  <%= default_form_field(f, :is_active, label_text: "Status") do |req| %>
    <div class="d-flex align-items-center gap-3">
      <div class="form-check form-switch">
        <%= f.check_box :is_active, { class: "form-check-input" } %>
        <label class="form-check-label" for="experiments_qnc_check_is_active">
          <%= @qnc_check.is_active? ? "Active" : "Inactive" %>
        </label>
      </div>
      <small class="text-muted">
        (<%= @qnc_check.is_active? ? "Uncheck to mark as inactive" : "Check to mark as active" %>)
      </small>
    </div>
  <% end %>

  <div class="mt-4">
    <div class="d-flex gap-2">
      <%= link_to "Cancel", experiments_qnc_check_path(@qnc_check), class: "btn btn-outline-secondary px-4" %>
      <%= f.submit "Update QNC Check", 
            class: "btn btn-primary px-4",
            data: { turbo_confirm: "Are you sure you want to update this QNC check?" } %>
    </div>
  </div>

<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('requestedFromInput');
    const dropdown = document.getElementById('userEmailsDropdown');
    const options = dropdown.querySelectorAll('.user-email-option');
    
    if (!input || !dropdown) return;
    
    // Show dropdown when input is focused or has value
    function showDropdown() {
      dropdown.classList.add('show');
      filterOptions();
    }
    
    // Hide dropdown
    function hideDropdown() {
      setTimeout(() => {
        dropdown.classList.remove('show');
      }, 200);
    }
    
    // Filter options based on input value
    function filterOptions() {
      const searchTerm = input.value.toLowerCase();
      let hasVisibleOptions = false;
      
      options.forEach(option => {
        const email = option.getAttribute('data-email').toLowerCase();
        const parent = option.closest('li');
        
        if (email.includes(searchTerm)) {
          parent.style.display = '';
          hasVisibleOptions = true;
        } else {
          parent.style.display = 'none';
        }
      });
      
      // Show/hide dropdown based on whether there are visible options
      if (hasVisibleOptions && input.value.length > 0) {
        dropdown.classList.add('show');
      } else if (input.value.length === 0) {
        dropdown.classList.add('show');
      }
    }
    
    // Handle input events
    input.addEventListener('input', function() {
      filterOptions();
    });
    
    input.addEventListener('focus', function() {
      showDropdown();
    });
    
    input.addEventListener('blur', function() {
      hideDropdown();
    });
    
    // Handle option clicks
    options.forEach(option => {
      option.addEventListener('click', function(e) {
        e.preventDefault();
        input.value = this.getAttribute('data-email');
        dropdown.classList.remove('show');
        input.focus();
      });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!input.contains(e.target) && !dropdown.contains(e.target)) {
        hideDropdown();
      }
    });
  });
</script>

