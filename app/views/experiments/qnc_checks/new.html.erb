<% 
  has_parent = @parent.present?
  if has_parent
    parent_name = @parent.respond_to?(:name) ? @parent.name : @parent.class.name.humanize
    page_subtitle = "Add a new QNC check for #{parent_name}."
    cancel_path = polymorphic_path(@parent)
  else
    page_subtitle = "Add a new QNC check."
    cancel_path = experiments_qnc_checks_path
  end
%>

<% content_for :page_title, render("shared/page_title", subtitle: page_subtitle) %>

<% if has_parent %>
  <div class="alert alert-info mb-4">
    <strong>Resource Name:</strong> 
    <%= @parent.class.name.split("::").last.humanize %> - 
    <% if @parent.respond_to?(:name) %>
      <%= link_to @parent.name.humanize, polymorphic_path(@parent), class: "text-decoration-underline" %>
    <% else %>
      ID: <%= @parent.id %>
    <% end %>
    <% if @parent.respond_to?(:qnc_checks_remaining) %>
      <% remaining_checks = @parent.qnc_checks_remaining %>
      <% if remaining_checks.present? %>
        <div class="mt-3">
          <strong>Samples for the following checks are not created:</strong>
          <ul class="mb-0 mt-2">
            <% remaining_checks.each do |check_name| %>
              <li><%= check_name %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>

<%= render "shared/form_errors", object: @qnc_check %>

<%= form_with(
  model: @qnc_check,
  url: experiments_qnc_checks_path,
  scope: :qnc_check,
  local: true,
  html: { class: "qnc-check-form" }
) do |f| %>
  
  <% if has_parent %>
    <%= hidden_field_tag :parent_type, @parent.class.name %>
    <%= hidden_field_tag :parent_id, @parent.id %>
  <% end %>
  
  <%= default_form_field(f, :name, label_text: "Name", required: true) do |req| %>
    <% 
      # Get QNC check names dynamically based on parent type
      qnc_check_options = if has_parent
        Experiments::QncCheck.qnc_check_names(@parent.class.name).map { |name| { key: name, val: name } }
      else
        []
      end
    %>
    <%= render "shared/forms/searchable_dropdown",
        form: f,
        field: :name,
        options: qnc_check_options,
        placeholder: "Search or type QNC check name...",
        help_text: has_parent && qnc_check_options.present? ? "You can search and select from the list or type a custom name." : "Enter QNC check name",
        required: true,
        input_attrs: req %>
  <% end %>

  <%= default_form_field(f, :location, label_text: "Sample Location", required: false) do |req| %>
    <%= f.text_field :location,
                    { class: "form-control",
                      placeholder: "Enter location (optional)" } %>
  <% end %>

  <%= default_form_field(f, :requested_from, label_text: "Assigned To", required: true) do |req| %>
    <%= render "shared/forms/searchable_dropdown",
        form: f,
        field: :requested_from,
        options: @users.map { |user| { key: user.email, val: user.email } },
        placeholder: "Search or type @swftlabs.com email",
        help_text: "Must be a valid @swftlabs.com email address. You can search and select from the list or type a new email.",
        required: true,
        input_attrs: req %>
  <% end %>

  <%= default_form_field(f, :expected_completion_date, label_text: "Expected Completion Date", required: true) do |req| %>
    <%= f.date_field :expected_completion_date,
                    { class: "form-control" }.merge(req) %>
  <% end %>

  <%= default_form_field(f, :created_at, label_text: "Date Added", required: false) do %>
    <%= f.date_field :created_at,
                    { class: "form-control",
                      value: Date.today } %>
  <% end %>

  <div class="mt-4">
    <div class="d-flex gap-2">
      <%= link_to "Cancel", cancel_path, class: "btn btn-outline-secondary px-4" %>
      <%= f.submit "Save QNC Check", 
            class: "btn btn-primary px-4",
            data: { turbo_confirm: "Are you sure you want to save this QNC check?" } %>
    </div>
  </div>

<% end %>

