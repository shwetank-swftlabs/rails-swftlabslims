<% content_for :page_title, render("shared/page_title",
  subtitle: "Manage library samples and their data.",
  actions: render("shared/add_button", label: "Add New Library Sample", path: new_inventory_library_sample_path)
) %>

<!-- UNIFIED FILTER BAR -->
<%= render "shared/tables/default_filter_bar",
    url: inventory_library_samples_path,
    search_placeholder: "Search by name…",
    filter_fields: ->(f) do %>

  <!-- Location Filter -->
  <div class="col-md-3">
    <div class="input-group">
      <%= f.text_field :location,
            value: params[:location],
            placeholder: "Filter by location…",
            class: "form-control" %>
      <%= f.submit "Search", class: "btn btn-secondary" %>
    </div>
  </div>

  <!-- Parent Name Filter -->
  <div class="col-md-3">
    <div class="input-group">
      <%= f.text_field :parent_name,
            value: params[:parent_name],
            placeholder: "Filter by resource name…",
            class: "form-control" %>
      <%= f.submit "Search", class: "btn btn-secondary" %>
    </div>
  </div>

  <!-- Active Status Filter -->
  <div class="col-md-3">
    <%= f.select :is_active,
        [["All", ""], ["Active", "true"], ["Inactive", "false"]],
        {
          include_blank: false,
          selected: params[:is_active] || ""
        },
        class: "form-select",
        onchange: "this.form.requestSubmit()" %>
  </div>

<% end %>

<!-- ACTIVE FILTERS -->
<% active_filters = [] %>
<% active_filters << { label: "Name: #{params[:q]}", param: :q } if params[:q].present? %>
<% active_filters << { label: "Location: #{params[:location]}", param: :location } if params[:location].present? %>
<% active_filters << { label: "Resource: #{params[:parent_name]}", param: :parent_name } if params[:parent_name].present? %>
<% 
  # Only show status filter badge when actually filtering (not showing "All")
  if params[:is_active].present?
    status_label = params[:is_active] == "true" ? "Active" : "Inactive"
    active_filters << { label: "Status: #{status_label}", param: :is_active }
  end
%>

<% if active_filters.any? %>
  <div class="mb-3">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <span class="text-muted small fw-bold">Active Filters:</span>
      <% active_filters.each do |filter| %>
        <% 
          # Build URL without this filter, preserving other params
          filter_params = params.to_unsafe_h.except(filter[:param], :controller, :action)
          clear_url = inventory_library_samples_path(filter_params)
        %>
        <a href="<%= clear_url %>" class="badge bg-secondary text-decoration-none d-flex align-items-center gap-1" style="font-size: 0.875rem;">
          <%= filter[:label] %>
          <i class="bi bi-x-circle" style="font-size: 0.75rem;"></i>
        </a>
      <% end %>
      <% if active_filters.length > 1 %>
        <% 
          # Clear all filters (no default status preserved)
          clear_all_url = inventory_library_samples_path
        %>
        <a href="<%= clear_all_url %>" class="badge bg-danger text-decoration-none" style="font-size: 0.875rem;">
          Clear All
        </a>
      <% end %>
    </div>
  </div>
<% end %>

<!-- LIBRARY SAMPLES TABLE -->
<%= render "shared/tables/default_table",
    collection: @library_samples,
    pagy: @pagy,
    headers: ->(_) do %>
      <th>Name</th>
      <th>Resource</th>
      <th>Amount</th>
      <th>Location</th>
      <th>Status</th>
      <th>Created By</th>
      <th>Created At</th>
      <th>Print QR</th>
    <% end,
    row: ->(library_sample) do %>
      <td><%= link_to library_sample.name.presence || "Unnamed", inventory_library_sample_path(library_sample), class: "text-decoration-underline fw-semibold" %></td>
        <td>
        <% parent = library_sample.library_sampleable %>
        <% if parent.present? && parent.respond_to?(:name) && parent.name.present? %>
          <%= link_to parent.name, polymorphic_path(parent), class: "text-decoration-underline" %>
        <% else %>
          —
        <% end %>
    </td>
      <td><%= library_sample.amount.present? ? "#{library_sample.amount} #{library_sample.unit.present? ? library_sample.unit.upcase : ''}".strip : "—" %></td>
      <td><%= library_sample.location.presence || "—" %></td>

      <td>
        <% if library_sample.is_active? %>
          <span class="badge bg-success">
            <i class="bi bi-check-circle me-1"></i>Active
          </span>
        <% else %>
          <span class="badge bg-danger">
            <i class="bi bi-x-circle me-1"></i>Inactive
          </span>
        <% end %>
      </td>
      <td><%= email_to_name(library_sample.created_by) %></td>
      <td><%= format_date(library_sample.created_at) %></td>
      <td><%= render "shared/print_qr_button", 
                      qr_code_path: qr_code_inventory_library_sample_path(library_sample),
                      label: "Print QR" %>
      </td>
    <% end %>

