<% 
  # Check if we have a maintenance_schedule with errors (from failed create)
  schedule_with_errors = local_assigns[:maintenance_schedule] if local_assigns.key?(:maintenance_schedule)
  show_form = schedule_with_errors&.errors&.any?
  schedules = equipment.maintenance_schedules.active.order(next_due_date: :asc)
%>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Maintenance Schedules</h5>
  <% unless show_form %>
    <button type="button" class="btn btn-primary btn-sm" onclick="showMaintenanceForm()" id="show-form-btn">
      <i class="bi bi-plus-circle me-1"></i>Add Maintenance Schedule
    </button>
  <% end %>
</div>

<!-- Inline Form Container -->
<div id="maintenance-form-container" style="display: <%= show_form ? 'block' : 'none' %>;" class="mb-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Add New Maintenance Schedule</h6>
      <button type="button" class="btn-close" aria-label="Close" onclick="hideMaintenanceForm()"></button>
    </div>
    <div class="card-body">
      <% 
        # Use schedule with errors if available, otherwise build new one
        form_schedule = schedule_with_errors || equipment.maintenance_schedules.build
      %>
      <%= render "inventory/maintenance_schedules/form", 
          equipment: equipment,
          maintenance_schedule: form_schedule %>
    </div>
  </div>
</div>

<!-- Schedules Table (hidden when form is shown) -->
<div id="schedules-table-container" style="display: <%= show_form ? 'none' : 'block' %>;">
  <% if schedules.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle table-compact">
        <thead class="table-light border-bottom">
          <tr>
            <th>Name</th>
            <th>Interval</th>
            <th>Next Due Date</th>
            <th>Last Completed</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <% schedules.each do |schedule| %>
            <tr>
              <td class="fw-semibold">
                <%= schedule.name %>
              </td>
              <td>
                <%= schedule.interval_days %> day<%= 's' unless schedule.interval_days == 1 %>
              </td>
              <td>
                <%= format_date(schedule.next_due_date) %>
              </td>
              <td>
                <%= schedule.last_completed_at.present? ? format_date(schedule.last_completed_at) : "â€”" %>
              </td>
              <td>
                <% 
                  due_date = schedule.next_due_date
                  today = Date.today
                  days_until = (due_date - today).to_i
                  
                  if days_until < 0
                    status_class = "bg-danger"
                    status_text = "Overdue"
                    status_icon = "bi-exclamation-triangle"
                  elsif days_until == 0
                    status_class = "bg-warning text-dark"
                    status_text = "Due Today"
                    status_icon = "bi-clock"
                  elsif days_until <= 7
                    status_class = "bg-warning text-dark"
                    status_text = "Due Soon"
                    status_icon = "bi-clock"
                  else
                    status_class = "bg-success"
                    status_text = "Upcoming"
                    status_icon = "bi-check-circle"
                  end
                %>
                <span class="badge <%= status_class %>">
                  <i class="bi <%= status_icon %> me-1"></i><%= status_text %>
                </span>
              </td>
              <td>
                <div class="d-flex gap-2">
                  <% if schedule.is_active? %>
                    <%= link_to "Complete", complete_inventory_equipment_maintenance_schedule_path(equipment, schedule),
                        method: :patch,
                        class: "btn btn-sm btn-success",
                        data: { turbo_confirm: "Mark this maintenance as complete? This will update the next due date." } %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info">
      <p class="mb-0">
        No maintenance schedules found for this equipment.
        <a href="#" onclick="showMaintenanceForm(); return false;" class="alert-link">Add one now</a>.
      </p>
    </div>
  <% end %>
</div>

<script>
  function showMaintenanceForm() {
    const formContainer = document.getElementById('maintenance-form-container');
    const tableContainer = document.getElementById('schedules-table-container');
    const showBtn = document.getElementById('show-form-btn');
    
    if (formContainer) {
      formContainer.style.display = 'block';
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    if (tableContainer) {
      tableContainer.style.display = 'none';
    }
    if (showBtn) {
      showBtn.style.display = 'none';
    }
  }

  function hideMaintenanceForm() {
    const formContainer = document.getElementById('maintenance-form-container');
    const tableContainer = document.getElementById('schedules-table-container');
    const showBtn = document.getElementById('show-form-btn');
    
    if (formContainer) {
      formContainer.style.display = 'none';
      // Reset form
      const form = document.getElementById('maintenance-schedule-form');
      if (form) {
        form.reset();
        // Clear any error messages
        const errorAlert = formContainer.querySelector('.alert-danger');
        if (errorAlert) {
          errorAlert.remove();
        }
      }
    }
    if (tableContainer) {
      tableContainer.style.display = 'block';
    }
    if (showBtn) {
      showBtn.style.display = 'inline-block';
    }
  }

  // Hide form on successful submit (handled by Turbo redirect)
  document.addEventListener('turbo:load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tab') === 'maintenance_schedules') {
      // Form was submitted successfully, hide it
      hideMaintenanceForm();
    }
  });
</script>
