<% 
  # Check if we have a maintenance_schedule with errors (from failed create/edit)
  schedule_with_errors = local_assigns[:maintenance_schedule] if local_assigns.key?(:maintenance_schedule)
  show_create_form = schedule_with_errors&.errors&.any? && !params[:edit_schedule_id]
  edit_schedule_id = params[:edit_schedule_id]&.to_i
  
  # Get active and inactive schedules separately
  active_schedules = equipment.maintenance_schedules.active.order(next_due_date: :asc)
  inactive_schedules = equipment.maintenance_schedules.inactive.order(updated_at: :desc)
  
  # Find the schedule being edited
  schedule_being_edited = nil
  if edit_schedule_id.present?
    schedule_being_edited = schedule_with_errors if schedule_with_errors&.id == edit_schedule_id
    schedule_being_edited ||= equipment.maintenance_schedules.find_by(id: edit_schedule_id)
  end
%>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Maintenance Schedules</h5>
  <% unless show_create_form || edit_schedule_id %>
    <button type="button" class="btn btn-primary btn-sm" onclick="showMaintenanceForm()" id="show-form-btn">
      <i class="bi bi-plus-circle me-1"></i>Add Maintenance Schedule
    </button>
  <% end %>
</div>

<!-- Inline Create Form Container -->
<div id="maintenance-form-container" style="display: <%= show_create_form ? 'block' : 'none' %>;" class="mb-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Add New Maintenance Schedule</h6>
      <button type="button" class="btn-close" aria-label="Close" onclick="hideMaintenanceForm()"></button>
    </div>
    <div class="card-body">
      <% 
        form_schedule = schedule_with_errors || equipment.maintenance_schedules.build
      %>
      <%= render "inventory/maintenance_schedules/form", 
          equipment: equipment,
          maintenance_schedule: form_schedule,
          form_type: :create %>
    </div>
  </div>
</div>

<!-- Inline Edit Form Container -->
<% if schedule_being_edited %>
  <div id="edit-form-container" class="mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Edit Maintenance Schedule</h6>
        <button type="button" class="btn-close" aria-label="Close" onclick="hideEditForm(<%= schedule_being_edited.id %>)"></button>
      </div>
      <div class="card-body">
        <%= render "inventory/maintenance_schedules/form", 
            equipment: equipment,
            maintenance_schedule: schedule_being_edited,
            form_type: :edit %>
      </div>
    </div>
  </div>
<% end %>

<!-- Schedules Table (hidden when form is shown) -->
<div id="schedules-table-container" style="display: <%= (show_create_form || edit_schedule_id) ? 'none' : 'block' %>;">
  <!-- Active Schedules -->
  <% if active_schedules.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle table-compact">
        <thead class="table-light border-bottom">
          <tr>
            <th style="width: 20%;">Name</th>
            <th style="width: 12%;">Interval</th>
            <th style="width: 15%;">Next Due Date</th>
            <th style="width: 15%;">Last Completed</th>
            <th style="width: 15%;">Status</th>
            <th style="width: 23%;">Actions</th>
          </tr>
        </thead>

        <tbody>
          <% active_schedules.each do |schedule| %>
            <tr>
              <td class="fw-semibold">
                <%= schedule.name %>
              </td>
              <td>
                <%= schedule.interval_days %> day<%= 's' unless schedule.interval_days == 1 %>
              </td>
              <td>
                <%= format_date(schedule.next_due_date) %>
              </td>
              <td>
                <%= schedule.last_completed_at.present? ? format_date(schedule.last_completed_at) : "—" %>
              </td>
              <td>
                <span class="badge <%= schedule.status_badge_class %>">
                  <i class="bi <%= schedule.status_icon %> me-1"></i><%= schedule.status_badge_text %>
                </span>
              </td>
              <td>
                <div class="d-flex gap-2">
                  <%= link_to edit_inventory_equipment_maintenance_schedule_path(equipment, schedule),
                      class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-pencil me-1"></i>Edit
                  <% end %>
                  <% if schedule.is_active? %>
                    <%= link_to "Complete", complete_inventory_equipment_maintenance_schedule_path(equipment, schedule),
                        method: :patch,
                        class: "btn btn-sm btn-success",
                        data: { turbo_confirm: "Mark this maintenance as complete? This will update the next due date." } %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info">
      <p class="mb-0">
        No active maintenance schedules found for this equipment.
        <a href="#" onclick="showMaintenanceForm(); return false;" class="alert-link">Add one now</a>.
      </p>
    </div>
  <% end %>

  <!-- Inactive Schedules Section -->
  <% if inactive_schedules.any? %>
    <div class="mt-5 pt-4 border-top">
      <h6 class="text-muted mb-3">
        <i class="bi bi-archive me-2"></i>Inactive Maintenance Schedules
      </h6>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle table-compact">
          <thead class="table-secondary border-bottom">
            <tr>
              <th style="width: 20%;">Name</th>
              <th style="width: 12%;">Interval</th>
              <th style="width: 15%;">Next Due Date</th>
              <th style="width: 15%;">Last Completed</th>
              <th style="width: 15%;">Status</th>
              <th style="width: 23%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% inactive_schedules.each do |schedule| %>
              <tr class="text-muted" style="opacity: 0.7;">
                <td class="fw-semibold">
                  <i class="bi bi-x-circle me-1 text-muted"></i><%= schedule.name %>
                </td>
                <td>
                  <%= schedule.interval_days %> day<%= 's' unless schedule.interval_days == 1 %>
                </td>
                <td>
                  <%= format_date(schedule.next_due_date) %>
                </td>
                <td>
                  <%= schedule.last_completed_at.present? ? format_date(schedule.last_completed_at) : "—" %>
                </td>
                <td>
                  <span class="badge bg-secondary">
                    <i class="bi bi-x-circle me-1"></i>Inactive
                  </span>
                </td>
                <td>
                  <%= link_to edit_inventory_equipment_maintenance_schedule_path(equipment, schedule),
                      class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-pencil me-1"></i>Edit
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>

<script>
  function showMaintenanceForm() {
    const formContainer = document.getElementById('maintenance-form-container');
    const tableContainer = document.getElementById('schedules-table-container');
    const showBtn = document.getElementById('show-form-btn');
    
    if (formContainer) {
      formContainer.style.display = 'block';
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    if (tableContainer) {
      tableContainer.style.display = 'none';
    }
    if (showBtn) {
      showBtn.style.display = 'none';
    }
  }

  function hideMaintenanceForm() {
    const formContainer = document.getElementById('maintenance-form-container');
    const tableContainer = document.getElementById('schedules-table-container');
    const showBtn = document.getElementById('show-form-btn');
    
    if (formContainer) {
      formContainer.style.display = 'none';
      const form = document.getElementById('maintenance-schedule-form');
      if (form) {
        form.reset();
        const errorAlert = formContainer.querySelector('.alert-danger');
        if (errorAlert) {
          errorAlert.remove();
        }
      }
    }
    if (tableContainer) {
      tableContainer.style.display = 'block';
    }
    if (showBtn) {
      showBtn.style.display = 'inline-block';
    }
  }

  function hideEditForm(scheduleId) {
    // Navigate back to equipment show page without edit_schedule_id
    window.location.href = '<%= inventory_equipment_path(equipment, tab: :maintenance_schedules) %>';
  }

  // Hide form on successful submit (handled by Turbo redirect)
  document.addEventListener('turbo:load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tab') === 'maintenance_schedules') {
      hideMaintenanceForm();
      // Clear edit_schedule_id if present
      if (urlParams.get('edit_schedule_id')) {
        urlParams.delete('edit_schedule_id');
        const newUrl = window.location.pathname + '?' + urlParams.toString();
        window.history.replaceState({}, '', newUrl);
      }
    }
  });
</script>
