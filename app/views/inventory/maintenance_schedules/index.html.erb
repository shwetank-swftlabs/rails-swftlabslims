<% content_for :page_title, render("shared/page_title",
  subtitle: "Manage maintenance schedules for #{@equipment.name}.",
  actions: render("shared/add_button", label: "Add Maintenance Schedule", path: new_inventory_equipment_maintenance_schedule_path(@equipment))
) %>

<!-- FILTER BAR -->
<%= form_with url: inventory_equipment_maintenance_schedules_path(@equipment), method: :get, local: true, class: "mb-4" do |f| %>
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <%= f.label :is_active, "Status", class: "form-label" %>
      <%= f.select :is_active,
          [["All", ""], ["Active", "true"], ["Inactive", "false"]],
          { selected: params[:is_active] },
          { class: "form-select", onchange: "this.form.submit();" } %>
    </div>
  </div>
<% end %>

<!-- MAINTENANCE SCHEDULES TABLE -->
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle table-compact">
    <thead class="table-light border-bottom">
      <tr>
        <th>Name</th>
        <th>Interval</th>
        <th>Next Due Date</th>
        <th>Last Completed</th>
        <th>Status</th>
        <th>Created By</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if @maintenance_schedules.any? %>
        <% @maintenance_schedules.each do |schedule| %>
          <tr>
            <td class="fw-semibold">
              <%= schedule.name %>
            </td>
            <td>
              <%= schedule.interval_days %> day<%= 's' unless schedule.interval_days == 1 %>
            </td>
            <td>
              <%= format_date(schedule.next_due_date) %>
            </td>
            <td>
              <%= schedule.last_completed_at.present? ? format_date(schedule.last_completed_at) : "—" %>
            </td>
            <td>
              <% 
                due_date = schedule.next_due_date
                today = Date.today
                days_until = (due_date - today).to_i
                
                if days_until < 0
                  status_class = "bg-danger"
                  status_text = "Overdue"
                  status_icon = "bi-exclamation-triangle"
                elsif days_until == 0
                  status_class = "bg-warning text-dark"
                  status_text = "Due Today"
                  status_icon = "bi-clock"
                elsif days_until <= 7
                  status_class = "bg-warning text-dark"
                  status_text = "Due Soon"
                  status_icon = "bi-clock"
                else
                  status_class = "bg-success"
                  status_text = "Upcoming"
                  status_icon = "bi-check-circle"
                end
              %>
              <span class="badge <%= status_class %>">
                <i class="bi <%= status_icon %> me-1"></i><%= status_text %>
              </span>
            </td>
            <td>
              <%= schedule.created_by.present? ? email_to_name(schedule.created_by) : "—" %>
            </td>
            <td>
              <div class="d-flex gap-2">
                <%= link_to "Edit", edit_inventory_equipment_maintenance_schedule_path(@equipment, schedule),
                    class: "btn btn-sm btn-outline-primary" %>
                <% if schedule.is_active? %>
                  <%= link_to "Complete", complete_inventory_equipment_maintenance_schedule_path(@equipment, schedule),
                      method: :patch,
                      class: "btn btn-sm btn-success",
                      data: { turbo_confirm: "Mark this maintenance as complete? This will update the next due date." } %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="7" class="text-muted text-center py-4">
            No maintenance schedules found.
            <%= link_to "Add one now", new_inventory_equipment_maintenance_schedule_path(@equipment), class: "text-decoration-underline" %>.
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% if defined?(@pagy) && @pagy.present? %>
  <div class="mt-3">
    <%== @pagy.series_nav(:bootstrap) %>
  </div>
<% end %>

